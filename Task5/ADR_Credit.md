### <a name="_b7urdng99y53"></a>**Название задачи:** Онлайн-кредитный процесс
### <a name="_hjk0fkfyohdk"></a>**Автор:** Степанова Айман
### <a name="_uanumrh8zrui"></a>**Дата:** 26.10.2025

## Контекст и цель
Команда цифровой трансформации инициировала цифровизацию кредитного направления.  
Клиенты должны иметь возможность подать заявку на кредит в **интернет-банке** и **на сайте**.  
При заполнении паспортных данных система должна выдать **предварительное решение** через интеграцию со скорингом, используя данные БКИ.  
При одобрении клиент получает СМС и направляется на **идентификацию в отделение**.  
Если клиент уже подавал заявку онлайн, менеджер в АБС должен продолжить работу с той же заявкой, без дублирования.  
В интернет-банке клиент может видеть **предодобренные предложения** и подавать заявку с подтверждением через OTP (одноразовый СМС-код).


### <a name="_3bfxc9a45514"></a>**Функциональные требования**

| № | Действующие лица / системы                       | Use Case                          | Описание                                                                                                                                                                  |
|:-:|--------------------------------------------------|-----------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1 | Клиент → Сайт → CAS (Credit Application Service) | Подача заявки на сайте            | Клиент вводит ФИО и телефон (F11), при наличии паспортных данных CAS инициирует онлайн-скоринг и получает предварительное решение.                                        |
| 2 | Клиент → Интернет-банк → CAS                     | Подача заявки в интернет-банке    | Авторизованный клиент видит список кредитов и предодобренные предложения (F14), указывает счёт для зачисления, подтверждает заявку одноразовым СМС-кодом (OTP) (F7, F15). |
| 3 | CAS → Скоринг                                    | Скоринг заявки (только сайт)      | CAS направляет данные в систему скоринга **только при фактической подаче** заявки и наличии паспортных данных (P3).                                                       |
| 4 | CAS → Кредитный конвейер                         | Подача заявки (интернет-банк)     | Для заявок из ИБ скоринг инициируется Конвейером, CAS только передаёт заявку (P3).                                                                                        |
| 5 | Клиент ← СМС-шлюз ← CAS                          | Уведомление о статусе заявки      | После обработки CAS отправляет СМС об изменении статуса (F16, F17).                                                                                                       |
| 6 | Менеджер → АБС                                   | Продолжение онлайн-заявки в офисе | Менеджер в АБС продолжает работу с заявкой клиента, созданной онлайн (F13).                                                                                               |
| 7 | Новый клиент → Отделение                         | Очная идентификация               | Для полностью нового клиента проводится идентификация в офисе (F4, +R1).                                                                                                  |

---

## Нефункциональные и архитектурно-значимые требования


| Код     | Требование                                                                                                                        |
|---------|-----------------------------------------------------------------------------------------------------------------------------------|
| **R1**  | Шифрование трафика HTTPS/TLS для всех каналов (сайт, ИБ).                                                                         |
| **R2**  | Исключить прямые вызовы API АБС из интернет-банка; все обращения идут через CAS.                                                  |
| **R3**  | Доступность CAS и ИБ не ниже 99,9 %, поддержка режима 24/7.                                                                       |
| **R4**  | Поддержка аварийного переключения на резервный ЦОД.                                                                               |
| **P1**  | Время отклика интерфейсов ≤ 1 с.                                                                                                  |
| **P2**  | CAS и ИБ поддерживают горизонтальное масштабирование и балансировку нагрузки.                                                     |
| **P3**  | Система скоринга не должна нагружаться дополнительными предрасчётами; допускается вызов только при **фактической** подаче заявки. |
| **S1**  | Использовать MS SQL и Java/Spring Boot, совместимые с платформами банка.                                                          |
| **S2**  | Разрабатывать документацию для расширения процесса.                                                                               |
| **S3**  | Применять технологии, по которым есть внутренняя экспертиза.                                                                      |
| **+R1** | Очная идентификация обязательна.                                                                                                  |
| **+R2** | Интернет-банк не зависит от Kafka.                                                                                                |
| **+R3** | АБС масштабируется вертикально.                                                                                                   |
| **+R4** | Не создавать онлайн-нагрузку на АБС.                                                                                              |
| **+R5** | Обмен между системами выполняется пакетно раз в сутки.                                                                            |

[Общий список требований](..%2FTask2%2FFURPS_plus_bank.md)
---

### <a name="_qmphm5d6rvi3"></a>**Решение**

Для MVP создаётся **Credit Application Service (CAS)** — сервис приёма и обработки кредитных заявок.  
Он принимает заявки из интернет-банка и сайта, выполняет онлайн-скоринг при наличии данных клиента, хранит статусы и отправляет уведомления.

Интеграции CAS ↔ АБС и CAS ↔ Кредитный конвейер выполняются **через существующий механизм пакетного обмена**, который уже используется между АБС и Конвейером.  
CAS формирует данные в том же формате и месте, откуда их считывает Конвейер.  
Технически это реализуется как пакетная интеграция **по расписанию (Batch 1×/сутки, +R5)**.  
Прямых JDBC-подключений к боевой БД АБС нет; ESB не используется.

Для заявок с **сайта** CAS вызывает скоринг только в момент **фактической подачи заявки** и при наличии паспортных данных (P3).  
Для заявок из **интернет-банка** скоринг выполняется **в Кредитном конвейере**, а CAS лишь отправляет заявку и получает обновления статусов асинхронно (Kafka).  
События `loan.status.changed` позволяют обновлять статусы клиента в тот же день, но финальное подтверждение выдачи кредита поступает из АБС пакетно (1×/сутки).  
CAS остаётся единой точкой доступа для фронтов (сайт, ИБ) и не взаимодействует с АБС напрямую (+R2, +R4, +R5).

## Диаграммы

- [Диаграмма контекста](credit_context.puml)
- [Диаграмма компонентов](credit_component.puml)
- [Диаграмма последовательности](sequence.puml)

## Эволюция решения (Target)

- Добавление асинхронной интеграции **Конвейер → Kafka → CAS** для обновления статусов заявок.
- Добавление пакетной актуализации по расписанию **CAS -> Конвейер** для пакетного обновления статусов заявок.
- CAS становится подписчиком событий `loan.status.changed`, обрабатывает их и уведомляет клиентов.
- Интернет-банк и сайт продолжают работать через REST (без зависимости от Kafka).
- Финальные статусы ("выдано" / "зачислено") всё так же приходят из АБС пакетно (1×/сутки).

---

## Альтернативы

| Вариант                           | Плюсы                                                                                 | Минусы                                                            |
|-----------------------------------|---------------------------------------------------------------------------------------|-------------------------------------------------------------------|
| **Прямые JDBC-подключения к АБС** | Проще реализовать                                                                     | Нарушает +R4, создаёт риски нагрузки и безопасности               |
| **ESB / интеграционная шина**     | Централизованное взаимодействие                                                       | Не предусмотрена в MVP, требует инфраструктуры                    |
| **Файловый обмен (FTP/SFTP)**     | Простой перенос данных                                                                | Медленнее, нет контроля успешности, требует дублирования форматов |
| **Конвейер → Kafka (Target)**     | Асинхронные статусы без нагрузки на АБС, постепенный переход к событийной архитектуре | Требует адаптации Конвейера и мониторинга доставки событий        |

---

## Ограничения решения

- Прямых подключений к боевой БД АБС нет.
- Интеграция по существующему механизму обмена через БД выполняется пакетно (1 раз в сутки, +R5).
- Онлайн-скоринг вызывается только по факту подачи заявки и только для заявок с сайта (P3).
- Для предодобренных заявок интернет-банка скоринг выполняется исключительно в Конвейере (P3).
- CAS получает статусы заявок из Конвейера (пакетно в MVP, асинхронно в Target).
- АБС масштабируется вертикально (+R3).
- ESB не используется в MVP.

---

## Риски и меры снижения

| Риск                           | Меры снижения                                                                                                                |
|--------------------------------|------------------------------------------------------------------------------------------------------------------------------|
| Сбой пакетной интеграции       | Повторная отправка, логирование ошибок в CAS                                                                                 |
| Расхождение данных CAS и АБС   | Контрольные суммы, сверка статусов при следующем обмене                                                                      |
| Ошибки скоринга                | Ретраи и отложенные повторные вызовы                                                                                         |
| Перегрузка скоринга            | Единая точка вызова (Конвейер), ограничение вызовов из CAS (только при подаче), rate-limit, circuit-breaker, идемпотентность |
| Нарушение SLA по ночным джобам | Мониторинг расписаний, уведомления о задержках                                                                               |
