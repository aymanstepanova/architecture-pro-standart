@startuml
title Процесс подачи и обработки кредитной заявки (MVP + Target)

actor Клиент as Client
participant "Сайт" as Web
participant "Интернет-банк" as IB
participant "CAS\n(Credit Application Service)" as CAS
participant "Скоринг" as Scoring
participant "Кредитный конвейер" as Conveyor
participant "АБС" as ABS
participant "Kafka" as Kafka
participant "СМС-шлюз" as SMS

== Сценарий 1: Новый клиент (через сайт) ==
Client -> Web : Заполняет заявку (ФИО, паспорт, сумма)
Web -> CAS : POST /applications (submit)
note right of CAS
  CAS вызывает скоринг **только при фактической подаче**
  и при наличии паспортных данных (P3)
end note
CAS -> Scoring : Онлайн-скоринг (API, on submit only)
Scoring --> CAS : Результат оценки
CAS -> Client : Показывает предварительное решение
CAS -> SMS : СМС: "Заявка получена, ожидайте"
SMS --> Client : СМС-уведомление

== Сценарий 2: Предодобренный клиент (через интернет-банк) ==
Client -> IB : Выбирает предодобренный кредит
IB -> CAS : POST /applications (submit)
CAS -> Conveyor : Отправка заявки (REST / Batch)
note right of Conveyor
  Скоринг вызывается **только Конвейером**, не CAS.
  CAS не выполняет предрасчёты.
end note
Conveyor -> Scoring : Онлайн-скоринг (API, 24/7)
Scoring --> Conveyor : Результат оценки
Conveyor -> Kafka : loan.status.changed (async event)
Kafka --> CAS : Событие об изменении статуса
CAS -> SMS : Отправить уведомление клиенту
SMS --> Client : СМС о статусе ("Одобрено / Отказ")

== Ежесуточный обмен с АБС ==
Conveyor -> ABS : Одобренные заявки (Batch 1×/сутки)
ABS -> ABS : Проведение договоров, зачисление средств
ABS --> Conveyor : Финальные статусы ("Выдано / Отказ")
Conveyor -> CAS : Финальные статусы (Batch 1×/сутки)
CAS -> SMS : СМС клиенту ("Средства зачислены")
SMS --> Client : Финальное уведомление

@enduml
